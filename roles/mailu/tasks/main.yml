- name: Ensure mailu namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: mailu
    state: present

- name: Add Mailu Helm repo
  ansible.builtin.shell: |
    helm repo add mailu https://mailu.github.io/helm-charts || true
    helm repo update
  changed_when: false

# - name: Initialize Mailu initial accounts dict
#   ansible.builtin.set_fact:
#     mailu_initial_accounts_dict: {}

# - name: Add each SMTP user to Mailu initial accounts dict
#   ansible.builtin.set_fact:
#     mailu_initial_accounts_dict: >-
#       {{
#         mailu_initial_accounts_dict | combine({
#           'user' ~ (idx + 1):
#             item.smtp.user ~ ':' ~
#             item.smtp.password ~ ':' ~
#             item.smtp.domain
#         })
#       }}
#   loop: "{{ self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list }}"
#   loop_control:
#     index_var: idx
#     label: "{{ item.name }}"
#   when: item.smtp.enabled | default(false)

# - name: Create Mailu initial accounts secret for SMTP users
#   kubernetes.core.k8s:
#     state: present
#     definition:
#       apiVersion: v1
#       kind: Secret
#       metadata:
#         name: mailu-initial-accounts
#         namespace: mailu
#       type: Opaque
#       stringData: "{{ mailu_initial_accounts_dict }}"
#   when: self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list | length > 0

- name: Set main Mailu domain from first enabled project
  ansible.builtin.set_fact:
    mailu_main_domain: >-
      {{ (self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list)[0].smtp.domain }}
  when: self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list | length > 0

- name: Set cert-manager issuer and domain logic
  ansible.builtin.set_fact:
    mailu_cert_issuer_name: "{{ 'letsencrypt-prod' if environment_type == 'prod' else 'selfsigned-cluster-issuer' }}"
    mailu_cert_issuer_kind: "ClusterIssuer"

- name: Create self-signed ClusterIssuer for local testing
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: selfsigned-cluster-issuer
      spec:
        selfSigned: {}
  when: environment_type == 'local_test'

- name: Render and apply Mailu cert-manager Certificate for all enabled domains
  ansible.builtin.template:
    src: mailu-certificate.yaml.j2
    dest: "/tmp/mailu-certificate.yaml"
    mode: '0644'
  when: self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list | length > 0

- name: Apply Mailu cert-manager Certificate manifest
  kubernetes.core.k8s:
    state: present
    src: "/tmp/mailu-certificate.yaml"
  when: self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list | length > 0

- name: Install Mailu using Helm for enabled projects (public SMTP)
  kubernetes.core.helm:
    name: "mailu"
    chart_ref: mailu/mailu
    release_namespace: mailu
    values:
      hostnames: "{{ self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | map(attribute='smtp.domain') | list }}"
      domain: "{{ mailu_main_domain }}"
      admin:
        enabled: "{{ mailu_enable_admin | default(true) }}"
      service:
        smtp:
          type: LoadBalancer
        submission:
          type: LoadBalancer
        smtps:
          type: LoadBalancer
      initialAccount:
        enabled: true
        username: "{{ mailu_admin_username }}"
        password: "{{ mailu_admin_password }}"
        domain: "{{ mailu_main_domain }}"
        mode: "update"
      persistence:
        enabled: true
        storageClass: "{{ mailu_storage_class }}"
        size: "{{ mailu_persistence_size }}"
      redis:
        master:
          persistence:
            enabled: true
            size: "{{ mailu_redis_size }}"
      clamav:
        enabled: "{{ mailu_enable_clamav | default(false) }}"
        persistence:
          enabled: true
          size: "{{ mailu_clamav_size }}"
      oletools:
        enabled: "{{ mailu_enable_oletools | default(false) }}"
      tika:
        enabled: "{{ mailu_enable_tika | default(false) }}"
      imap:
        enabled: false
      pop3:
        enabled: false
      webmail:
        enabled: false
      antivirus:
        enabled: false
      front:
        hostPort:
          enabled: false
        externalService:
          enabled: true
          type: LoadBalancer
          externalTrafficPolicy: Local
    wait: true
    wait_timeout: 5m
  when: self_saas_projects | selectattr('smtp.enabled', 'defined') | selectattr('smtp.enabled') | list | length > 0
